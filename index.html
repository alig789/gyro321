<!DOCTYPE html>
<html lang="en">

<head>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,height=device-height,user-scalable=no,initial-scale=1.0">
    <title>Gyroscope</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { margin: 0; padding-bottom: 3rem; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color:rgb(66, 65, 65) }
        button {
			color: #ffffff;
			background-color: #000000;
			font-size: 19px;
			border: 5px solid rgb(32, 32, 32);
			padding: 15px 50px;
			cursor: pointer;
		}
		button:hover {
			color: #212325;
			background-color: #4b4b4b;
		}
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            
            z-index: 100;
            display: block;
        }
        #canvas1{
            position: absolute;
            top: 250px;
        }
    </style>
</head>
<body>
    <div id="info">
        <h1 id="id01">ID: N/A</h1>
        <h1 id="id02">Connected Users: N/A</h1>
        <button id="input">iPhone users click here!</button>
        <button id="input2">Check connections</button>

        <p></p>

    </div>


    <canvas id="canvas1"></canvas>


    <!-- <script type="text/javascript" src="display.js"></script>-->
    <!--<script type="text/javascript" src="gyroscope.js"></script>-->
    <!--<script type="text/javascript" src="script.js"></script>-->
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="three.js"></script>








    <script>




        var socket = io();

        var messages = document.getElementById('messages');
        var form = document.getElementById('form');
        var input = document.getElementById('input');

        input.addEventListener('click', function (e) {



            askPermission()




        });

        input2.addEventListener('click', function (e) {

            socket.emit('chat message');


        });

        socket.on('new_connect', function (id) {

            const element = document.getElementById("id01");
            element.innerHTML = "ID: " + id;


            gyroObject.num_id = id
            socket.emit('created_gyro', gyroObject, id);

            runGyroscope();

        });


        socket.on('update_count', function (users) {
            const element2 = document.getElementById("id02");
            element2.innerHTML = "Connected Users: " + users;
        });

        socket.on('average_orientation', function (average) {

            average_orientation = average;
        });

        /*socket.on('update_gyro', function (new_phone) {
            update(new_phone);

        });
        */







        const canvas = document.getElementById('canvas1');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let updateCount = 0;

        class displayCanvas {
            constructor() {
                this.updateCount = 0;
            }
            update() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                //ctx.fillStyle = "white";
                //ctx.fillRect(0, 0, canvas.width, canvas.height);

                //Make it change colors while you tilt the x, y, z
                /*ctx.fillStyle = `rgb(
                        ${Math.floor(255 - Math.abs(gyroObject.x / 2))},
                        ${Math.floor(255 - Math.abs(gyroObject.y))},
                        ${Math.floor(255 - Math.abs(gyroObject.z))}`;
                */
                //ctx.fillRect(0, 0, canvas.width, canvas.height);

                //ctx.fillStyle = "gray";
                ctx.font = "20px Georgia";
                ctx.fillText("Your info:", 10, 20);
                ctx.fillText("x: " + parseInt(gyroObject.x), 10, 50);
                ctx.fillText("y: " + parseInt(gyroObject.y), 10, 80);
                ctx.fillText("z: " + parseInt(gyroObject.z), 10, 110);

                ctx.fillText("Average info:", 10, 140);
                ctx.fillText("x: " + parseInt(average_orientation[0]), 10, 170);
                ctx.fillText("y: " + parseInt(average_orientation[1]), 10, 200);
                ctx.fillText("z: " + parseInt(average_orientation[2]), 10, 230);
                //ctx.fillText("Updates: " + this.updateCount, 10, 260);
                this.updateCount++;

            }


        }


        function askPermission() {   //askPermission is an HTML requirement of iOS
            DeviceOrientationEvent.requestPermission() //This asks for permission (iOS requirement)
            window.addEventListener("deviceorientation", function (event) { //This listens to the phone orientation values
                controller.x = event.alpha;
                controller.y = event.beta;
                controller.z = event.gamma;
            });
        }

        //Android users will have their data automatically working on page load from this one.  It can be removed, the button above should also work.
        if (window.DeviceOrientationEvent) {
            window.addEventListener("deviceorientation", function (event) {
                controller.x = event.alpha;
                controller.y = event.beta;
                controller.z = event.gamma;

            });
        }



        //This is where we are temporarily storing the values.  Each Gyroscope client/Object made from script.js will have it's own x, y, z.


        //This will be the main Gyroscope object, we can initialize it in the main (script.js) if we've confirmed a mobile device.
        //That object can then use the functions within the class below.
        const controller = {
            x: 0,
            y: 0,
            z: 0
        }

        //This will be the main Gyroscope object, we can initialize it in the main (script.js) if we've confirmed a mobile device.
        //That object can then use the functions within the class below.
        class Gyroscope {
            constructor(num_id) {

                this.num_id = num_id;
                this.x = controller.x
                this.y = controller.y
                this.z = controller.z
            }

            //We will call this function recursively from script.  It will return the device orientation data.
            update() {

                gyroObject.x = controller.x
                gyroObject.y = controller.y
                gyroObject.z = controller.z
                socket.emit('gyro_update', this.num_id, this.x, this.y, this.z);
            }



            //Now that we have the X,Y,Z values, we need to send the data to the server and the client webpage will be finished.


        }
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        scene.background = new THREE.Color(0x707070);

        const geometry = new THREE.BoxGeometry();

        
        const texture = new THREE.TextureLoader().load("textures/cobble.png");
        texture.wrapS = THREE.RepeatWrapping;
        texture.wrapT = THREE.RepeatWrapping;
        

        const material = new THREE.MeshBasicMaterial({ map:texture });
        //const material = new THREE.MeshBasicMaterial({ color: 0x000000 });
        const cube = new THREE.Mesh(geometry, material);
        scene.add(cube);

        camera.position.z = 5;

        function animate() {
            requestAnimationFrame(animate);
            
        }


        //Initialize the Gyroscope object for the mobile user
        let average_orientation = [0, 0, 0];
        let gyroObject = new Gyroscope(0);
        let display = new displayCanvas();
        let frameCounter = 0;

        //This is the recursive function that will keep updating the gyroscope and display canvas
        function runGyroscope() {
            gyroObject.update();
            display.update();
            frameCounter++;
            cube.rotation.x = (average_orientation[1] / 180);
            cube.rotation.y = (average_orientation[2] / 180);
            renderer.render(scene, camera);
            requestAnimationFrame(runGyroscope);
        }








    </script>
</body>
</html>

